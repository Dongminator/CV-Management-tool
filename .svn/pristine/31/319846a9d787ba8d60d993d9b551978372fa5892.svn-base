/*
 * Initialise editable functions
 */
/*jslint browser: true*/
/*global $, jQuery*/
//get last id of full cv

function lastId(cv){
	var hi = 0;
	for(var i=0; i<cv.category.length; i++){
		var catid = cv.category[i].id;
		if(hi<catid) hi = catid;
		for(var j=0; j<cv.category[i].item.length; j++){
			var itemid = cv.category[i].item[j].id;
			if(hi<itemid) hi = itemid;
		}
	}
	
	return ++hi; //return new available id
}

//get all categories of full cv
function getCategories(cv){
	var arr = new Array();
	for(var i=0; i<cv.category.length; i++){
		arr.push(cv.category[i].title);
	}
	return arr;
}

function getCVS(cv){
	var arr = new Array();
	for(var i=0; i<cv.currentcv.length; i++){
		arr.push(cv.currentcv[i].title);
	}
	return arr;
}

function editableInit(cv,currcv) {
    "use strict";
    $('.current_items').sortable({
		helper: "clone",
		appendTo: "body"
	});
    
    $('#cv_sp').sortable({
		helper: "clone",
		appendTo: "body"
	});
	
	$('.hide').siblings().hide();
	//End of Jahid's
	
	$('.editable').click(function(){
		
		var thisone = $(this).attr("id"); //id is set such as : edit(id of current class being changed)
		
		var old = $(this).text();
			
		if($(this).children('textarea').length===0){
			var txt = "<textarea id=edit" +thisone+ " wrap=\"soft\">"+$(this).text()+"</textarea>";
			$(this).html(txt);

			$("#edit"+thisone).blur(function(){
				var value = $(this).val();
				if(value===""){
					$('#'+thisone+'.editable').text(old); //revert to previous one if empty
				}else{
					$('#'+thisone+'.editable').text(value);
				}
			});
						
			$("#edit"+thisone).focus();
			
			$("#edit"+thisone).keypress(function (event){
				if (event.keyCode===13) {//13 = Enter
					event.preventDefault();
					$(this).blur();
				}
				else if(event.keyCode===27){
					$('#'+thisone+'.editable').text(old); //revert to previous one if esc
					$(this).blur();
				}
			});
		}
	});
	
	$("#cvs").change(function(){
		var item = $(this).val().replace("_", " ");
		document.getElementById('cv_sp').innerHTML = currentcvParser(cv,currcv);
		var lastid = lastId(cv); //waiting for function
		addInit(lastid,cv,currcv);
		editableInit(cv,currcv);
	});
}
function addInit(id,cv,currcv){
	 var category = $("#category"),
	 	category1 = $("#category1"),
	    title = $("#title"),
	    content = $("#content"),
	    allFields = $([]).add(category).add(category1).add(title).add(content); 
		$("#dialog-form").dialog({
	    	autoOpen: false,
	    	height: 300,
	    	width: 350,
	    	modal: true,
	    	buttons: {
	        	"Add": function(){
    				allFields.removeClass( "ui-state-error" );
	    			if($('input:radio[name=cats]:checked').val()==="opt1"){
	    				$("#category").removeAttr("disabled");
	    				$("#category1").attr("disabled","disabled");
    					$("#"+category.val()).children('ul').append("<li id="+parseInt(lastId(cv))+" class=\"item\"><div class=\"hidable\"><h3 class=\"hide\">"+title.val()+"</h3><p><span id=\""+parseInt(lastId(cv))+"\" class=\"editable\">"+content.val()+"</span></p></div></li>");
    					saveResource(cv); //save the data
    					editableInit(cv,currcv); //re-initialise span classes to be editable
            			$( this ).dialog( "close" );
            		}else{
	    				$("#category1").removeAttr("disabled");
	    				$("#category").attr("disabled","disabled");
	    				var newcat = category1.val().replace(" ", "_");
            			$("#full_sp").append("<div id=\""+newcat+"\" class=\"cvcategory\" cvid=\""+parseInt(lastId(cv))+"\"><h3 class=\"category_title\">"+category1.val()+"</h3><ul class=\"items\"><li id="+parseInt(lastId(cv)+1)+" class=\"item\"><div class=\"hidable\"><h3 class=\"hide\">"+title.val()+"</h3><p><span id=\""+parseInt(lastId(cv)+1)+"\" class=\"editable\">"+content.val()+"</span></p></div></li>");
    					saveResource(cv); //save the data
            			editableInit(cv,currcv); //re-initialise span classes to be editable
            			$( this ).dialog( "close" );
            		}
	        	},
	        	Cancel: function(){
	            	$( this ).dialog( "close" );
	        	}
	    	},
	    	close: function(){
	        	allFields.val( "" ).removeClass( "ui-state-error" );
	    	}
	});
}
/*
 * Add new CV
 */
function addCV(cv,currcv,cvs){
	 var cvname = $("#cvname"),
	    allFields = $([]).add(cvname);
		$("#dialog-form2").dialog({
	    	autoOpen: false,
	    	height: 300,
	    	width: 350,
	    	modal: true,
	    	buttons: {
	        	"Add": function(){
    				allFields.removeClass( "ui-state-error" );
	        		var newcv = {
							"title": cvname.val(),
							"content": [
							]
						};
					currcv.currentcv[currcv.currentcv.length] = newcv; //appends new CV
					
	        		var item = cvname.val().replace(" ", "_");
	        		
	        		cvs.push(cvname.val());
	        		document.getElementById('cvs').innerHTML = arrVals(cvs); //load cvs on combo box

					$("#cvs").val(cvname.val());
	        		document.getElementById('cv_sp').innerHTML = currentcvParser(cv,currcv);
					
           			$( this ).dialog( "close" );
	        	},
	        	Cancel: function(){
	            	$( this ).dialog( "close" );
	        	}
	    	},
	    	close: function(){
	        	allFields.val( "" ).removeClass( "ui-state-error" );
        		//document.getElementById('cv_sp').innerHTML = currentcvParser(cv,currcv,cvname.val());

	    	}
	});
}
/*
 * Swap label colours and functionality
 */
function setEnabled(){
	if($('input:radio[name=cats]:checked').val()==="opt1"){
		$("#category").removeAttr("disabled");
		$("#oldlabel").css('color', '#000000');

		$("#category1").attr("disabled","disabled");
		$("#newlabel").css('color', '#808080');

	}else{
		$("#category1").removeAttr("disabled");
		$("#newlabel").css('color', '#000000');

		
		$("#category").attr("disabled","disabled");
		$("#oldlabel").css('color', '#808080');

	}
}

/*
 * Initialise effects and functions
 */
function init(cv,currcv){
	$('body').on('click', '.hide',function(){
		$(this).siblings().slideToggle('fast');
	}); 
	
	$('#full_sp').on('dblclick', '.cvcategory',function(){
		var currid = $(this).attr('id');
		
		if (!document.getElementById("current_"+currid)){
			
			var newone = $(this).clone(true).attr('id','current_'+currid).attr('class','currentcat');
			
			newone.children('ul').each(function(){
				$(this).attr('class','current_items');
			})
			
			.children().each(function(){
				var itemid = $(this).attr('id');
				$(this).attr('id','curr'+itemid);
			});
			
			newone.appendTo($('#cv_sp'));
			
		}else{
			alert("CATEGORY ALREADY EXISTS IN CURRENT CV!");
		}
		editableInit(cv,currcv); //re-initialise span classes to be editable
	});
	
	$('#full_sp').on('dblclick', '.item',function(){
		var currid = $(this).attr('id');
		
		if (!document.getElementById("curr"+currid)){
			$(this).clone(true).attr('id','curr'+currid).appendTo($('#current_'+$(this).parent().parent().attr('id')).children('ul'));
		}else{
			alert("ITEM ALREADY EXISTS IN CURRENT CV!");
		} 
	});
	
	$('#cv_sp').on('dblclick', '.item',function(){
		if(confirm("Are you sure you want to remove the current element?")){
			$(this).remove();
		}
	});
	
	$('#cv_sp').on('dblclick', '.currentcat',function(){
		if(confirm("Are you sure you want to remove the current category?")){
			$(this).remove();
		}
	});
	
	//$("ul, li").disableSelection();
    $( ".button" ).click(function(){
        $( ".cv1" ).switchClass( "cv1", "cv2", 1000 );
        $( ".cv2" ).switchClass( "cv2", "cv1", 1000 );
        $( ".full1" ).switchClass( "full1", "full2", 1000 );
        $( ".full2" ).switchClass( "full2", "full1", 1000 );
        return false;
    });
    
    $( ".button_d" ).click(function(){
        $( ".profile1" ).switchClass( "profile1", "profile2", 1000 );
        $( ".profile2" ).switchClass( "profile2", "profile1", 1000 );
        $( ".cvlist1" ).switchClass( "cvlist1", "cvlist2", 1000 );
        $( ".cvlist2" ).switchClass( "cvlist2", "cvlist1", 1000 );
        return false;
    });
    
    $( "#create-item" )
	.button()
	.click(function() {
		setEnabled();
    	$( "#dialog-form" ).dialog( "open" );
	});
    
    $( "#create-cv" )
	.button()
	.click(function() {
    	$( "#dialog-form2" ).dialog( "open" );
	});
    
    $("input[name='cats']").change(function(){
    	setEnabled();
    });
}

function arrVals(arr){
	var str="";
	var i;
	for(i=0; i<arr.length; i++) {
		var item = arr[i].replace(" ", "_");
			str += '<option value="' +item+ '">'+arr[i]+'</option>';
	}

	return str;
}
