import json

import logging

from reportlab.lib.styles import ParagraphStyle
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, ListFlowable, ListItem
from reportlab.lib.pagesizes import A4

from base import BaseHandler

# Alignment
# TA_LEFT = 0
# TA_CENTER = 1
# TA_RIGHT = 2
# TA_JUSTIFY = 4

def extractCV(cv, currcv, cv_title):
    cv_ob = json.loads(cv)
    currcv_ob = json.loads(currcv)

    extract = {}
    category_list = []
    extract_list = []
    extract['header'] = cv_ob['header']
    for cv_item in currcv_ob['currentcv']:
        if cv_title == cv_item['title']:
            extract_list = cv_item['content']
    
    for dict_e in extract_list:
        for dict_t in cv_ob['category']:
            if dict_e['category'] == dict_t['id']:
                s_category = {}
                s_category['title'] = dict_t['title']
                s_category['item'] = []
                for order in dict_e['order']:
                    for item in dict_t['item']:
                        if order == item['id']:
                            s_category['item'].append(item)
                category_list.append(s_category)
                
    extract['category'] = category_list
    return json.dumps(extract)

class PDFGenerate():
    page_elements = []
    document = None
    template = None

    def getDocument(self, document_str):
        self.document = json.loads(document_str)

    def getTemplate_str(self, template_str):
        self.template = json.loads(template_str)

    def getTemplate(self, template_file):
        temp = open(template_file, "r")
        self.template = json.load(temp)      
        temp.close()

    def _getParaStyle(self, paragraph_type):
        style_set = self.template[paragraph_type]
        style = ParagraphStyle(name=paragraph_type, **style_set)
        return style

    def generate_page_elements(self):
        ''' Style '''
        header_style = self._getParaStyle('header')
        header_item_style = self._getParaStyle('header-item')
        category_item_style = self._getParaStyle('category-item')
        category_style = self._getParaStyle('category')
        
        list_bullet = self.template['list-bullet']
        item_bullet = self.template['item-bullet'] 
        
        ''' Header '''
        # Name on cv page
        self.page_elements.append(Paragraph(self.document['header']['name'], header_style))
        # Phone and address        
        self.page_elements.append(Paragraph("Address: "+self.document['header']['address'],header_item_style))        
        self.page_elements.append(Paragraph("Phone: "+self.document['header']['phone'],header_item_style))
        
        ''' Page '''
        for cat in self.document['category']:
            self.page_elements.append(Paragraph(cat['title'],category_style))
            for items in cat['item']:
                para_items = []
                para_items.append(ListItem(Paragraph(items['content'],category_item_style),**item_bullet))
                list_items = ListFlowable(para_items, **list_bullet)
            self.page_elements.append(list_items)
        self.page_elements.insert(0,Spacer(0,10))

class PDFExportHandler(BaseHandler):
    cv_title = ''
    template_name = ''
    
    def get(self):
        if self.logged_in:
            user = self.current_user
            if self.request.get('title') != '':
                self.cv_title = self.request.get('title')
            if self.request.get('template') != '':
                self.template_name = self.request.get('template')
            
            document = extractCV(user.cv, user.currcv, self.cv_title)
            
            generator = PDFGenerate()
            generator.getDocument(document)
            if self.template_name == 'Classic':
                generator.getTemplate_str('''{    
                                                "header":{
                                                    "fontName": "Times-Bold",
                                                    "fontSize": 18,
                                                    "leading": 22,
                                                    "spaceBefore":0,
                                                    "spaceAfter":10,
                                                    "alignment": 1
                                                },
                                                "header-item":{
                                                    "fontName": "Times-Roman",
                                                    "fontSize": 13,
                                                    "leading": 15,
                                                    "alignment": 1
                                                },
                                                "category":{
                                                    "fontName": "Times-Bold",
                                                    "fontSize": 16,
                                                    "leading": 18,
                                                    "spaceBefore":16,
                                                    "spaceAfter":8,
                                                    "alignment": 0
                                                },
                                                "category-item":{
                                                    "fontName": "Times-Roman",
                                                    "fontSize": 12,
                                                    "leading" : 14,
                                                    "alignment": 0
                                                },
                                                "list-bullet":{
                                                    "bulletType":"bullet"
                                                },
                                                "item-bullet":{
                                                    "bulletColor": "black",
                                                    "value":"square"
                                                }
                                            }''')
            if self.template_name == 'Modern':
                generator.getTemplate_str('''{    
                                                "header":{
                                                    "fontName": "Courier-Bold",
                                                    "fontSize": 20,
                                                    "leading": 22,
                                                    "spaceBefore":0,
                                                    "spaceAfter":10,
                                                    "alignment": 1
                                                },
                                                "header-item":{
                                                    "fontName": "Helvetica",
                                                    "fontSize": 13,
                                                    "leading": 15,
                                                    "alignment": 1
                                                },
                                                "category":{
                                                    "fontName": "Helvetica-BoldOblique",
                                                    "fontSize": 15,
                                                    "leading": 18,
                                                    "spaceBefore":16,
                                                    "spaceAfter":8,
                                                    "alignment": 0
                                                },
                                                "category-item":{
                                                    "fontName": "Helvetica",
                                                    "fontSize": 12,
                                                    "leading" : 14,
                                                    "alignment": 0
                                                },
                                                "list-bullet":{
                                                    "bulletType":"bullet"
                                                },
                                                "item-bullet":{
                                                    "bulletFontName": "Times-Bold",
                                                    "value":"diamond"
                                                }
                                            }''')
            
            generator.generate_page_elements()
            
            self.response.headers['Content-Type'] = 'application/pdf'
            self.response.headers['Content-Disposition'] = 'attachment; filename=cv.pdf'
            doc = SimpleDocTemplate(self.response.out, pagesize=A4) 
            doc.build(generator.page_elements)

        else:
            self.redirect('/')
